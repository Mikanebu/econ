#!/usr/bin/env python

import cmd

class EconAdmin(cmd.Cmd):

    prompt = 'econ-admin > '

    def __init__(self):
        cmd.Cmd.__init__(self) # cmd.Cmd is not a new style class

    def run_interactive(self, line=None):
        """Run an interactive session.
        """
        print 'Welcome to econ-admin interactive mode\n'
        self.do_about()
        print 'Type:  "?" or "help" for help on commands.\n'
        while 1:
            try:
                self.cmdloop()
                break
            except KeyboardInterrupt:
                raise

    def do_help(self, line=None):
        cmd.Cmd.do_help(self, line)

    def do_about(self, line=None):
        import econ
        version = econ.__version__
        about = \
'''Open Econ version %s. Copyright the Open Knowledge Foundation.
Open Econ is open-knowledge and open-source. See LICENSE.txt for details.
''' % version
        print about

    def do_quit(self, line=None):
        sys.exit()

    def do_EOF(self, *args):
        print ''
        sys.exit()

    # --------------
    # start commands

    def do_store_index(self, line=None):
        import econ.store
        if line:
            basePath = line
        else:
            basePath = econ.get_config()['data_store_path']
        indexList = econ.store.make_index(basePath)
        for key, item in indexList.items():
            print str(item) + '\n'

    def help_store_index(self, line=None):
        usage = \
'''store_index <store-path>

Print an index of the data store located at <store-path>. If <store-path> not
supplied then use data_store_path specified in config.'''
        print usage

    def _runserver_paste_plain(self):
        import econ.www.plainwsgi
        import paste.httpserver
        app = econ.www.plainwsgi.EconWebInterface()
        paste.httpserver.serve(app)

    def do_runserver(self, line=None):
        if not line: # default
            self._runserver_paste_plain()
        else:
            print 'Unknown argument: %s' % line
            self.help_runserver()

    def help_runserver(self, line=None):
        usage = \
'''runserver

Start a webserver (of optional type) to provide a web user interface to the
econ package.

The resulting website should be availabe at http://localhost:8080
'''
        print usage

    def do_bundle(self, line=None):
        args = []
        if line:
            args = line.split()
        if args and args[0] == 'make': # default
            import econ
            args = line.split() 
            if len(args) > 1:
                path = args[1]
            else:
                store_path = econ.get_config()['data_store_path']
                path = store_path
            import econ.store.bundle
            bndl = econ.store.bundle.create(path)
            print 'Created new data bundle %s at %s' % (bndl.id, bndl.path)
        else:
            print 'Unknown argument: %s' % line
            self.help_bundle()

    def help_bundle(self, line=None):
        usage = \
'''bundle make [path]

make: create a new data empty data bundle at path. If path not provided create
the bundle in the default data store (as specified in the config file).
'''
        print usage



if __name__ == '__main__':
    import sys
    adminCmd = EconAdmin()
    if len(sys.argv) < 2:
        adminCmd.run_interactive()
    else:
        args = ' '.join(sys.argv[1:])
        adminCmd.onecmd(args)
