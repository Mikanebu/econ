#!/usr/bin/env python

import cmd

class EconAdmin(cmd.Cmd):

    prompt = 'econ-admin > '

    def __init__(self):
        cmd.Cmd.__init__(self) # cmd.Cmd is not a new style class

    def run_interactive(self, line=None):
        """Run an interactive session.
        """
        print 'Welcome to econ-admin interactive mode\n'
        self.do_about()
        print 'Type:  "?" or "help" for help on commands.\n'
        while 1:
            try:
                self.cmdloop()
                break
            except KeyboardInterrupt:
                raise

    def do_help(self, line=None):
        cmd.Cmd.do_help(self, line)

    def do_about(self, line=None):
        import econ
        version = econ.__version__
        about = \
'''Open Econ version %s. Copyright the Open Knowledge Foundation.
Open Econ is open-knowledge and open-source. See COPYING for details.
''' % version
        print about

    def do_quit(self, line=None):
        sys.exit()

    def do_EOF(self, *args):
        print ''
        sys.exit()

    # --------------
    # start commands

    def do_store_index(self, line=None):
        import econ.store.DataBundle
        basePath = line
        indexList = econ.store.make_index(basePath)
        for key, item in indexList.items():
            print key + '\t' + str(item) + '\n\n'

    def help_store_index(self, line=None):
        usage = \
'''store_index <store-path>

Print an index of the data store located at <store-path>'''
        print usage

    def do_runserver(self, line=None):
        import econ.www.cherrypysite
        import cherrypy
        cherrypy.root = econ.www.cherrypysite.EconWebInterface()
        configDict = {
                'server.socketPort' : 8080,
                'server.threadPool' : 10,
                'server.showTracebacks' : True
                }
        cherrypy.config.update(configDict)
        cherrypy.server.start()

    def help_runserver(self, line=None):
        usage = \
'''Start a cherrypy webserver to provide access to econ web interface

NB: the resulting website should be availabe at http://localhost:8080
'''
        print usage


if __name__ == '__main__':
    import sys
    adminCmd = EconAdmin()
    if len(sys.argv) < 2:
        adminCmd.run_interactive()
    else:
        args = ' '.join(sys.argv[1:])
        adminCmd.onecmd(args)
